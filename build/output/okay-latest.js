// Okay.JS
// by Hunter Loftis <hunter@hunterloftis.com>
//
// Version 0.1.0
window.ok=window.ok||{};
(function(d,e){var b,a,c;function j(){var a=e.uniq(k.pop());k.length===0&&(h=!1);i=e(k).last();return a}function g(d){d._subscriptions=[];d.subscribe=b;d.publish=a;d.unsubscribe=c;d.__isSubscribable=!0}function f(){this.functions=[];this.running=!1}d.dom={};d.template={};d.binding={};d.debug={};d.debug.SUBSCRIPTION_COUNT=0;d.debug.UPDATE_COUNT=0;var h=!1,k=[],i=null,l={};b=function(a,c){if(!e(this._subscriptions).any(function(b){return b.callback===a&&b.context===c}))d.debug.SUBSCRIPTION_COUNT++,this._subscriptions.push({callback:a,
context:c||this}),a._publishers=a._publishers||[],e(a._publishers).contains(this)||a._publishers.push(this)};a=function(a){e(this._subscriptions).each(function(c){c.callback.call(c.context,a)},this)};c=function(a){d.debug.SUBSCRIPTION_COUNT--;var c;for(c=this._subscriptions.length;c--;)this._subscriptions[c].callback===a&&(this._subscriptions[c].splice(c,1),c=-1);for(c=a._publishers.length;c--;)a._publishers[c]===this&&(a._publishers.splice(c,1),c=-1)};d.base=function(c){function a(){if(arguments.length>
0)return b!==arguments[0]&&(b=arguments[0],a.publish(b)),this;h&&i.push(a);return b}var b=c;g(a);return a};d.collection=function(a){function c(){if(arguments.length>0)return d=arguments[0],c.publish(d),this;h&&i.push(c);return d}function b(a){return function(){typeof d==="undefined"&&(d=[]);var b=d[a].apply(d,arguments);c.publish(d);return b}}var d=a;e("pop,push,reverse,shift,sort,splice,unshift".split(",")).each(function(a){c[a]=b(a)});g(c);return c};f.prototype={push:function(a){e(this.functions).indexOf(a)===
-1&&(this.functions.push(a),this.running||this.run())},run:function(){this.running=!0;for(var a=this.functions.length,a=a>3?3:a;a--;);(a=this.functions.shift())?a(this.complete):this.running=!1},complete:function(){setTimeout(function(){o.run()},1)}};var o=new f;d.dependent=function(a,c){function b(){h&&i.push(b);return m}function l(){f()}function f(g){d.debug.UPDATE_COUNT++;var p=l._publishers?l._publishers.slice():[],n;h=!0;i=[];k.push(i);var q=m;m=a.call(c);n=j();e(p).each(function(a){a.unsubscribe(l)});
e(n).each(function(a){a.subscribe(l)});m!==q&&b.publish(m);return g&&g(void 0)}var m;g(b);f();return b};d.dep=function(a,c){var b=new Function("return "+a);return d.dependent(b,c)};d.bind=function(a,c,b){var c=c||"",j="data-bind"+(c.length>0?"-"+c:""),g="data-watch"+(c.length>0?"-"+c:""),h=d.dom.nodesWithAttr(j,b),f=l[c]=[];e(h).each(function(c){var b=d.dom.attr(c,j);with(a)eval("var bindingObject = {"+b+"}");e.each(bindingObject,function(b,e){var j=d.binding[e](c,b,a,!1);j instanceof Array?f.concat(j):
f.push(j)})});c=d.dom.nodesWithAttr(g,b);e(c).each(function(c){var b=d.dom.attr(c,g);with(a)eval("var bindingObject = {"+b+"}");e.each(bindingObject,function(b,e){var j=d.binding[e](c,b,a,!0);j instanceof Array?f.concat(j):f.push(j)})});return f};d.unbind=function(a){var a=a||"",c=l[a];if(c)e(c).each(function(a){a.release()}),l[a]=[];else throw Error("Nothing is bound to namespace '"+a+"'");};d.safeSubscribe=function(a,c,b){if(a)if(a.subscribe)a.subscribe(c,b),c.call(b,a());else return c.call(b,a)}})(window.ok,
window._);(function(d){(d.utils={}).toJSON=function b(a){if(typeof a==="function"){if(a.__isSubscribable)return b(a())}else if(typeof a==="object"){var c;c=a instanceof Array?[]:{};for(var d in a)c[d]=b(a[d]);return c}else return a}})(ok,_);
(function(d,e){var b=d.dom;b.nodesWithAttr=function(a,c){var b="*["+a+"]";if(c){var d=e(c).find("*["+a+"]");return e(c).is(b)?e(c).add(d):d}return e(b)};b.createNode=function(a){return e(a)};b.append=function(a,c){e(a).append(c)};b.remove=function(a){e(a).remove()};b.after=function(a,c){e(a).after(c)};b.before=function(a,c){e(a).before(c)};b.attr=function(a,c){return e(a).attr(c)};b.show=function(a){e(a).show()};b.hide=function(a){e(a).hide()};b.text=function(a,c){e(a).html(c)};b.html=function(a,
c){return e(a).html(c)};b.value=function(a,c){return e(a).val(c)};b.bind=function(a,c,b,d){var f=function(){b.call(d)};e(a).bind(c,f);return f};b.unbind=function(a,c,b){e(a).unbind(c,b)};b.attribute=function(a,c,b){return e(a).attr(c,b)};b.removeAttribute=function(a,c){e(a).removeAttr(c)};b.is=function(a,c){return e(a).is(c)}})(window.ok,window.Zepto);(function(d,e){d.template.render=function(b,a){return e.template(b,a)}})(window.ok,window._);
(function(d){function e(b,a){this.node=b;this.subscribable=a;d.safeSubscribe(a,this.update,this)}e.prototype={update:function(b){b?d.dom.show(this.node):d.dom.hide(this.node)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.visible=function(b,a){return new e(b,a)}})(ok);
(function(d){function e(b,a,c,e){this.update=e?_(this._update).debounce(0):this._update;this.node=b;this.subscribable=a;d.safeSubscribe(a,this.update,this)}e.prototype={_update:function(b){d.dom.html(this.node,b)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.html=function(b,a,c,d){return new e(b,a,c,d)};d.debug.HtmlBinding=e})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$(b).bind("click",_.bind(this.activate,this))}e.prototype={activate:function(b){this.callback.call(this.vm,[b])||(b.preventDefault(),b.stopPropagation())},release:function(){$(node).unbind("click",this.callback)}};d.binding.click=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$(b).bind("submit",_.bind(this.activate,this))}e.prototype={activate:function(b){this.callback.call(this.vm,[b])||(b.preventDefault(),b.stopPropagation())},release:function(){$(node).unbind("submit",this.callback)}};d.binding.submit=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$.os.ios||$.os.android||$.os.webos||$.os.touchpad||$.os.iphone||$.os.ipad||$.os.blackberry?($(b).bind("tap",_.bind(this.activate,this)),$(b).bind("touchstart",_.bind(this.btn_down,this)),$(b).bind("touchend",_.bind(this.btn_up,this))):($(b).bind("click",_.bind(this.activate,this)),$(b).bind("mousedown",_.bind(this.btn_down,this)),$(b).bind("mouseup",_.bind(this.btn_up,this)))}e.prototype={activate:function(b){this.callback.call(this.vm,
[b])||(b.preventDefault(),b.stopPropagation())},release:function(){},btn_down:function(){$(this.node).addClass("ok_down")},btn_up:function(){$(this.node).removeClass("ok_down")}};d.binding.tap=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(a,b){this.node=a;this.subscribable=b;b.subscribe(this.updateNode,this);this.updateNode(b());this.bindNode(a)}function b(a,b){this.node=a;this.subscribable=b;b.subscribe(this.updateNode,this);this.updateNode(b());this.bindNode(a)}e.prototype={bindNode:function(a){this.handler=d.dom.bind(a,"keyup",this.updateSubscribable,this)},updateNode:function(a){d.dom.value(this.node,a)},updateSubscribable:function(){this.subscribable(d.dom.value(this.node))},release:function(){this.subscribable.unsubscribe(this.updateNode);
d.dom.unbind(this.node,"keyup",this.handler)}};b.prototype={bindNode:function(a){this.handler=d.dom.bind(a,"change",this.updateSubscribable,this)},updateNode:function(a){a?d.dom.attribute(this.node,"checked",!0):d.dom.removeAttribute(this.node,"checked")},updateSubscribable:function(){this.subscribable(d.dom.is(this.node,":checked")!==!1)},release:function(){d.dom.unbind(this.node,"change",this.handler)}};var a={text:e,checkbox:b};d.binding.value=function(b,e){var g=d.dom.attribute(b,"type");return new (a[g]||
a.text)(b,e)}})(ok);
(function(d){function e(a,b,e,g){this.update=g?_(this._update).debounce(0):this._update;this.node=a;this.templateId="#"+b.template;this.subscribable=b.collection;this._items=[];d.dom.html(this.node,"");d.safeSubscribe(this.subscribable,this.update,this)}var b={};e.prototype={_update:function(a){var c=this,e;typeof b[this.templateId]==="undefined"&&(b[this.templateId]=_.template(d.dom.html(this.templateId)));e=b[this.templateId];var g=_(this._items).pluck("data"),f,h,k=[];_(a).each(function(a,b){if(c._items.length>
b)if(f=c._items[b],f.data===a)k.push(f);else{var i=_(g).indexOf(a);i>=0?(d.dom.before(f.node,c._items[i].node),k.push(c._items[i])):(h=d.dom.createNode(e(a)),d.dom.before(f.node,h),d.bind(a,null,h),k.push({data:a,node:h}))}else h=d.dom.createNode(e(a)),d.dom.append(c.node,h),d.bind(a,null,h),k.push({data:a,node:h})});var i=[];_(this._items).each(function(b){_(a).contains(b.data)||i.push(b)});_(i).each(function(a){d.dom.remove(a.node)});this._items=k},release:function(){this.subscribable.unsubscribe(this.update)}};
d.binding.repeat=function(a,b,d,g){return new e(a,b,d,g)};d.debug.RepeatBinding=e})(ok);(function(d){function e(b,a,c){this.node=b;this.className=a;this.subscribable=c;d.safeSubscribe(c,this.update,this)}e.prototype={update:function(b){b?$(this.node).addClass(this.className):$(this.node).removeClass(this.className)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.css=function(b,a){var c=[],d;for(d in a)c.push(new e(b,d,a[d]));return c}})(ok);
(function(d){function e(b,a,c){this.node=b;this.attrName=a;this.subscribable=c;d.safeSubscribe(c,this.update,this)}e.prototype={update:function(b){$(this.node).attr(this.attrName,b)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.attr=function(b,a){var c=[],d;for(d in a)c.push(new e(b,d,a[d]));return c}})(ok);
