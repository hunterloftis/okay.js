// Okay.JS
// by Hunter Loftis <hunter@hunterloftis.com>
//
// Version 0.1.0
window.ok=window.ok||{};
(function(c,d){var a,b,e;function g(){var b=d.uniq(j.pop());j.length===0&&(h=!1);i=d(j).last();return b}function f(c){c._subscriptions=[];c.subscribe=a;c.publish=b;c.unsubscribe=e;c.__isSubscribable=!0}c.dom={};c.template={};c.binding={};var h=!1,j=[],i=null,k={};a=function(b,a){this._subscriptions.push({callback:b,context:a||this});b._publishers=b._publishers||[];d(b._publishers).contains(this)||b._publishers.push(this)};b=function(b){d(this._subscriptions).each(function(a){a.callback.call(a.context,b)},
this)};e=function(b){this._subscriptions=d(this._subscriptions).reject(function(a){return a.callback===b});b._publishers=d(b._publishers).without(this)};c.base=function(b){function a(){if(arguments.length>0)return e!==arguments[0]&&(e=arguments[0],a.publish(e)),this;h&&i.push(a);return e}var e=b;f(a);return a};c.collection=function(b){function a(){if(arguments.length>0)return c=arguments[0],a.publish(c),this;h&&i.push(a);return c}function e(b){return function(){typeof c==="undefined"&&(c=[]);var e=
c[b].apply(c,arguments);a.publish(c);return e}}var c=b;d("pop,push,reverse,shift,sort,splice,unshift".split(",")).each(function(b){a[b]=e(b)});f(a);return a};c.dependent=function(b,a){function e(){h&&i.push(e);return k}function c(){var f=c._publishers?c._publishers.slice():[],m;h=!0;i=[];j.push(i);k=b.call(a);m=g();var n=d(f).select(function(b){return!d(m).contains(b)}),o=d(m).select(function(b){return!d(f).contains(b)});d(n).each(function(b){b.unsubscribe(c)});d(o).each(function(b){b.subscribe(c)});
e.publish(k)}var k;f(e);c();return e};c.dep=function(b,a){var e=new Function("return "+b);return c.dependent(e,a)};c.bind=function(b,a,e){var a=a||"",g="data-bind"+(a.length>0?"-"+a:""),e=c.dom.nodesWithAttr(g,e),f=k[a]=[];d(e).each(function(a){var e=c.dom.attr(a,g);with(b)eval("var bindingObject = {"+e+"}");d.each(bindingObject,function(e,d){var g=c.binding[d](a,e,b);g instanceof Array?f.concat(g):f.push(g)})})};c.unbind=function(b){var b=b||"",a=k[b];if(a)d(a).each(function(b){b.release()}),k[b]=
[];else throw Error("Nothing is bound to namespace '"+b+"'");};c.safeSubscribe=function(b,a,e){b.subscribe?(b.subscribe(a,e),a.call(e,b())):a.call(e,b)}})(window.ok,window._);(function(c){(c.utils={}).toJSON=function a(b){if(typeof b==="function"){if(b.__isSubscribable)return a(b())}else if(typeof b==="object"){var e;e=b instanceof Array?[]:{};for(var c in b)e[c]=a(b[c]);return e}else return b}})(ok,_);
(function(c,d){var a=c.dom;a.nodesWithAttr=function(b,a){var c="*["+b+"]";if(a){var f=d(a).find("*["+b+"]");return d(a).is(c)?d(a).add(f):f}return d(c)};a.createNode=function(b){return d(b)};a.append=function(b,a){d(b).append(a)};a.remove=function(b){d(b).remove()};a.after=function(b,a){d(b).after(a)};a.before=function(b,a){d(b).before(a)};a.attr=function(b,a){return d(b).attr(a)};a.show=function(b){d(b).show()};a.hide=function(b){d(b).hide()};a.text=function(b,a){d(b).html(a)};a.html=function(b,
a){return d(b).html(a)};a.value=function(a,c){return d(a).val(c)};a.bind=function(a,c,g,f){var h=function(){g.call(f)};d(a).bind(c,h);return h};a.unbind=function(a,c,g){d(a).unbind(c,g)};a.attribute=function(a,c,g){return d(a).attr(c,g)};a.removeAttribute=function(a,c){d(a).removeAttr(c)};a.is=function(a,c){return d(a).is(c)}})(window.ok,window.Zepto);(function(c,d){c.template.render=function(a,b){return d.template(a,b)}})(window.ok,window._);
(function(c){function d(a,b){this.node=a;this.subscribable=b;c.safeSubscribe(b,this.update,this)}d.prototype={update:function(a){a?c.dom.show(this.node):c.dom.hide(this.node)},release:function(){this.subscribable.unsubscribe(this.update)}};c.binding.visible=function(a,b){return new d(a,b)}})(ok);
(function(c){function d(a,b){this.node=a;this.subscribable=b;c.safeSubscribe(b,this.update,this)}d.prototype={update:function(a){c.dom.html(this.node,a)},release:function(){this.subscribable.unsubscribe(this.update)}};c.binding.html=function(a,b){return new d(a,b)}})(ok);
(function(c){function d(a,b,c){this.node=a;this.callback=b;this.vm=c;$(a).bind("click",_.bind(this.activate,this))}d.prototype={activate:function(a){this.callback.call(this.vm,[a])||(a.preventDefault(),a.stopPropagation())},release:function(){$(node).unbind("click",this.callback)}};c.binding.click=function(a,b,c){return new d(a,b,c)}})(ok);
(function(c){function d(a,b,c){this.node=a;this.callback=b;this.vm=c;$(a).bind("submit",_.bind(this.activate,this))}d.prototype={activate:function(a){this.callback.call(this.vm,[a])||(a.preventDefault(),a.stopPropagation())},release:function(){$(node).unbind("submit",this.callback)}};c.binding.submit=function(a,b,c){return new d(a,b,c)}})(ok);
(function(c){function d(a,b,c){this.node=a;this.callback=b;this.vm=c;$.os.ios||$.os.android||$.os.webos||$.os.touchpad||$.os.iphone||$.os.ipad||$.os.blackberry?($(a).bind("tap",_.bind(this.activate,this)),$(a).bind("touchstart",_.bind(this.btn_down,this)),$(a).bind("touchend",_.bind(this.btn_up,this))):($(a).bind("click",_.bind(this.activate,this)),$(a).bind("mousedown",_.bind(this.btn_down,this)),$(a).bind("mouseup",_.bind(this.btn_up,this)))}d.prototype={activate:function(a){this.callback.call(this.vm,
[a])||(a.preventDefault(),a.stopPropagation())},release:function(){},btn_down:function(){$(this.node).addClass("ok_down")},btn_up:function(){$(this.node).removeClass("ok_down")}};c.binding.tap=function(a,b,c){return new d(a,b,c)}})(ok);
(function(c){function d(a,b){this.node=a;this.subscribable=b;b.subscribe(this.updateNode,this);this.updateNode(b());this.bindNode(a)}function a(a,b){this.node=a;this.subscribable=b;b.subscribe(this.updateNode,this);this.updateNode(b());this.bindNode(a)}d.prototype={bindNode:function(a){this.handler=c.dom.bind(a,"keyup",this.updateSubscribable,this)},updateNode:function(a){c.dom.value(this.node,a)},updateSubscribable:function(){this.subscribable(c.dom.value(this.node))},release:function(){this.subscribable.unsubscribe(this.updateNode);
c.dom.unbind(this.node,"keyup",this.handler)}};a.prototype={bindNode:function(a){this.handler=c.dom.bind(a,"change",this.updateSubscribable,this)},updateNode:function(a){a?c.dom.attribute(this.node,"checked",!0):c.dom.removeAttribute(this.node,"checked")},updateSubscribable:function(){var a=c.dom.is(this.node,":checked")!==!1;console.log("UPDATING WITH VALUE "+a);console.log("("+c.dom.is(this.node,":checked")+")");this.subscribable(a)},release:function(){c.dom.unbind(this.node,"change",this.handler)}};
var b={text:d,checkbox:a};c.binding.value=function(a,d){var f=c.dom.attribute(a,"type");return new (b[f]||b.text)(a,d)}})(ok);
(function(c){function d(a,b){this.node=a;this.templateId="#"+b.template;this.subscribable=b.collection;this._items=[];c.dom.html(this.node,"");c.safeSubscribe(this.subscribable,this.update,this)}d.prototype={update:function(a){var b=this,d=c.dom.html(this.templateId),g=_(this._items).pluck("data"),f,h,j=[];_(a).each(function(a,i){if(b._items.length>i)if(f=b._items[i],f.data===a)j.push(f);else{var l=_(g).indexOf(a);l>=0?(c.dom.before(f.node,b._items[l].node),j.push(b._items[l])):(h=c.dom.createNode(c.template.render(d,
a)),c.dom.before(f.node,h),c.bind(a,null,h),j.push({data:a,node:h}))}else h=c.dom.createNode(c.template.render(d,a)),c.dom.append(b.node,h),c.bind(a,null,h),j.push({data:a,node:h})});var i=[];_(this._items).each(function(b){_(a).contains(b.data)||i.push(b)});_(i).each(function(a){c.dom.remove(a.node)});this._items=j},release:function(){this.subscribable.unsubscribe(this.update)}};c.binding.repeat=function(a,b,c){return new d(a,b,c)}})(ok);
(function(c){function d(a,b,d){this.node=a;this.className=b;this.subscribable=d;c.safeSubscribe(d,this.update,this)}d.prototype={update:function(a){a?$(this.node).addClass(this.className):$(this.node).removeClass(this.className)},release:function(){this.subscribable.unsubscribe(this.update)}};c.binding.css=function(a,b){var c=[],g;for(g in b)c.push(new d(a,g,b[g]));return c}})(ok);
