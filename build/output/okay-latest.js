// Okay.JS
// by Hunter Loftis <hunter@hunterloftis.com>
//
// Version 0.1.0
window.ok=window.ok||{};
(function(d,e){var c,a,b;function i(){var b=e.uniq(f.pop());f.length===0&&(g=!1);j=e(f).last();return b}function k(d){d._subscriptions=[];d.subscribe=c;d.publish=a;d.unsubscribe=b;d.__isSubscribable=!0}d.dom={};d.template={};d.binding={};d.debug={};var g=!1,f=[],j=null,h={};c=function(b,a){this._subscriptions.push({callback:b,context:a||this});b._publishers=b._publishers||[];e(b._publishers).contains(this)||b._publishers.push(this)};a=function(b){e(this._subscriptions).each(function(a){a.callback.call(a.context,b)},
this)};b=function(b){this._subscriptions=e(this._subscriptions).reject(function(a){return a.callback===b});b._publishers=e(b._publishers).without(this)};d.base=function(b){function a(){if(arguments.length>0)return c!==arguments[0]&&(c=arguments[0],a.publish(c)),this;g&&j.push(a);return c}var c=b;k(a);return a};d.collection=function(b){function a(){if(arguments.length>0)return d=arguments[0],a.publish(d),this;g&&j.push(a);return d}function c(b){return function(){typeof d==="undefined"&&(d=[]);var c=
d[b].apply(d,arguments);a.publish(d);return c}}var d=b;e("pop,push,reverse,shift,sort,splice,unshift".split(",")).each(function(b){a[b]=c(b)});k(a);return a};d.dependent=function(b,a){function c(){g&&j.push(c);return h}function d(){var k=d._publishers?d._publishers.slice():[],l;g=!0;j=[];f.push(j);h=b.call(a);l=i();var m=e(k).select(function(b){return!e(l).contains(b)}),n=e(l).select(function(b){return!e(k).contains(b)});e(m).each(function(b){b.unsubscribe(d)});e(n).each(function(b){b.subscribe(d)});
c.publish(h)}var h;k(c);d();return c};d.dep=function(b,a){var c=new Function("return "+b);return d.dependent(c,a)};d.bind=function(b,a,c){var a=a||"",i="data-bind"+(a.length>0?"-"+a:""),k="data-watch"+(a.length>0?"-"+a:""),g=d.dom.nodesWithAttr(i,c),f=h[a]=[];e(g).each(function(a){var c=d.dom.attr(a,i);with(b)eval("var bindingObject = {"+c+"}");e.each(bindingObject,function(c,e){var i=d.binding[e](a,c,b,!1);i instanceof Array?f.concat(i):f.push(i)})});a=d.dom.nodesWithAttr(k,c);e(a).each(function(a){var c=
d.dom.attr(a,k);with(b)eval("var bindingObject = {"+c+"}");e.each(bindingObject,function(c,e){var i=d.binding[e](a,c,b,!0);i instanceof Array?f.concat(i):f.push(i)})});return f};d.unbind=function(b){var b=b||"",a=h[b];if(a)e(a).each(function(b){b.release()}),h[b]=[];else throw Error("Nothing is bound to namespace '"+b+"'");};d.safeSubscribe=function(b,a,c){if(b)if(b.subscribe)b.subscribe(a,c),a.call(c,b());else return a.call(c,b)}})(window.ok,window._);
(function(d){(d.utils={}).toJSON=function c(a){if(typeof a==="function"){if(a.__isSubscribable)return c(a())}else if(typeof a==="object"){var b;b=a instanceof Array?[]:{};for(var d in a)b[d]=c(a[d]);return b}else return a}})(ok,_);
(function(d,e){var c=d.dom;c.nodesWithAttr=function(a,b){var c="*["+a+"]";if(b){var d=e(b).find("*["+a+"]");return e(b).is(c)?e(b).add(d):d}return e(c)};c.createNode=function(a){return e(a)};c.append=function(a,b){e(a).append(b)};c.remove=function(a){e(a).remove()};c.after=function(a,b){e(a).after(b)};c.before=function(a,b){e(a).before(b)};c.attr=function(a,b){return e(a).attr(b)};c.show=function(a){e(a).show()};c.hide=function(a){e(a).hide()};c.text=function(a,b){e(a).html(b)};c.html=function(a,
b){return e(a).html(b)};c.value=function(a,b){return e(a).val(b)};c.bind=function(a,b,c,d){var g=function(){c.call(d)};e(a).bind(b,g);return g};c.unbind=function(a,b,c){e(a).unbind(b,c)};c.attribute=function(a,b,c){return e(a).attr(b,c)};c.removeAttribute=function(a,b){e(a).removeAttr(b)};c.is=function(a,b){return e(a).is(b)}})(window.ok,window.Zepto);(function(d,e){d.template.render=function(c,a){return e.template(c,a)}})(window.ok,window._);
(function(d){function e(c,a){this.node=c;this.subscribable=a;d.safeSubscribe(a,this.update,this)}e.prototype={update:function(c){c?d.dom.show(this.node):d.dom.hide(this.node)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.visible=function(c,a){return new e(c,a)}})(ok);
(function(d){function e(c,a,b,e){this.update=e?_(this._update).debounce(0):this._update;this.node=c;this.subscribable=a;console.dir(a);d.safeSubscribe(a,this.update,this)}e.prototype={_update:function(c){d.dom.html(this.node,c)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.html=function(c,a,b,d){return new e(c,a,b,d)};d.debug.HtmlBinding=e})(ok);
(function(d){function e(c,a,b){this.node=c;this.callback=a;this.vm=b;$(c).bind("click",_.bind(this.activate,this))}e.prototype={activate:function(c){this.callback.call(this.vm,[c])||(c.preventDefault(),c.stopPropagation())},release:function(){$(node).unbind("click",this.callback)}};d.binding.click=function(c,a,b){return new e(c,a,b)}})(ok);
(function(d){function e(c,a,b){this.node=c;this.callback=a;this.vm=b;$(c).bind("submit",_.bind(this.activate,this))}e.prototype={activate:function(c){this.callback.call(this.vm,[c])||(c.preventDefault(),c.stopPropagation())},release:function(){$(node).unbind("submit",this.callback)}};d.binding.submit=function(c,a,b){return new e(c,a,b)}})(ok);
(function(d){function e(c,a,b){this.node=c;this.callback=a;this.vm=b;$.os.ios||$.os.android||$.os.webos||$.os.touchpad||$.os.iphone||$.os.ipad||$.os.blackberry?($(c).bind("tap",_.bind(this.activate,this)),$(c).bind("touchstart",_.bind(this.btn_down,this)),$(c).bind("touchend",_.bind(this.btn_up,this))):($(c).bind("click",_.bind(this.activate,this)),$(c).bind("mousedown",_.bind(this.btn_down,this)),$(c).bind("mouseup",_.bind(this.btn_up,this)))}e.prototype={activate:function(c){this.callback.call(this.vm,
[c])||(c.preventDefault(),c.stopPropagation())},release:function(){},btn_down:function(){$(this.node).addClass("ok_down")},btn_up:function(){$(this.node).removeClass("ok_down")}};d.binding.tap=function(c,a,b){return new e(c,a,b)}})(ok);
(function(d){function e(b,a){this.node=b;this.subscribable=a;a.subscribe(this.updateNode,this);this.updateNode(a());this.bindNode(b)}function c(b,a){this.node=b;this.subscribable=a;a.subscribe(this.updateNode,this);this.updateNode(a());this.bindNode(b)}e.prototype={bindNode:function(b){this.handler=d.dom.bind(b,"keyup",this.updateSubscribable,this)},updateNode:function(b){d.dom.value(this.node,b)},updateSubscribable:function(){this.subscribable(d.dom.value(this.node))},release:function(){this.subscribable.unsubscribe(this.updateNode);
d.dom.unbind(this.node,"keyup",this.handler)}};c.prototype={bindNode:function(b){this.handler=d.dom.bind(b,"change",this.updateSubscribable,this)},updateNode:function(b){b?d.dom.attribute(this.node,"checked",!0):d.dom.removeAttribute(this.node,"checked")},updateSubscribable:function(){var b=d.dom.is(this.node,":checked")!==!1;console.log("UPDATING WITH VALUE "+b);console.log("("+d.dom.is(this.node,":checked")+")");this.subscribable(b)},release:function(){d.dom.unbind(this.node,"change",this.handler)}};
var a={text:e,checkbox:c};d.binding.value=function(b,c){var e=d.dom.attribute(b,"type");return new (a[e]||a.text)(b,c)}})(ok);
(function(d){function e(a,b,c,e){this.update=e?_(this._update).debounce(0):this._update;this.node=a;this.templateId="#"+b.template;this.subscribable=b.collection;this._items=[];d.dom.html(this.node,"");d.safeSubscribe(this.subscribable,this.update,this)}var c={};e.prototype={_update:function(a){var b=this,e;typeof c[this.templateId]==="undefined"&&(c[this.templateId]=_.template(d.dom.html(this.templateId)));e=c[this.templateId];var k=_(this._items).pluck("data"),g,f,j=[];_(a).each(function(a,c){if(b._items.length>
c)if(g=b._items[c],g.data===a)j.push(g);else{var h=_(k).indexOf(a);h>=0?(d.dom.before(g.node,b._items[h].node),j.push(b._items[h])):(f=d.dom.createNode(e(a)),d.dom.before(g.node,f),d.bind(a,null,f),j.push({data:a,node:f}))}else f=d.dom.createNode(e(a)),d.dom.append(b.node,f),d.bind(a,null,f),j.push({data:a,node:f})});var h=[];_(this._items).each(function(b){_(a).contains(b.data)||h.push(b)});_(h).each(function(a){d.dom.remove(a.node)});this._items=j},release:function(){this.subscribable.unsubscribe(this.update)}};
d.binding.repeat=function(a,b,c,d){return new e(a,b,c,d)};d.debug.RepeatBinding=e})(ok);(function(d){function e(c,a,b){this.node=c;this.className=a;this.subscribable=b;d.safeSubscribe(b,this.update,this)}e.prototype={update:function(c){c?$(this.node).addClass(this.className):$(this.node).removeClass(this.className)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.css=function(c,a){var b=[],d;for(d in a)b.push(new e(c,d,a[d]));return b}})(ok);
(function(d){function e(c,a,b){this.node=c;this.attrName=a;this.subscribable=b;d.safeSubscribe(b,this.update,this)}e.prototype={update:function(c){$(this.node).attr(this.attrName,c)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.attr=function(c,a){var b=[],d;for(d in a)b.push(new e(c,d,a[d]));return b}})(ok);
