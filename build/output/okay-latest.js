// Okay.JS
// by Hunter Loftis <hunter@hunterloftis.com>
//
// Version 0.1.0
window.ok=window.ok||{};
(function(d,e){var b,a,c;function g(d){d.subscribe=b;d.publish=a;d.unsubscribe=c;d._publishesToHash={};d._subscribesTo={};d._isSubscribable=!0;d._subscriber_hash=k++}function h(){this.functions=[];this.running=!1}d.dom={};d.template={};d.binding={};d.debug={};d.debug.SUBSCRIPTION_COUNT=0;d.debug.UPDATE_COUNT=0;var f=!1,i=[],j=null,l={},k=1;b=function(a){var c=a._subscriber_hash=a._subscriber_hash||k++;if(!this._publishesToHash[c])this._publishesToHash[c]=a,d.debug.SUBSCRIPTION_COUNT++,a._subscribesTo=
a._subscribesTo||{},a._subscribesTo[this._subscriber_hash]=this};a=function(a){e(this._publishesToHash).each(function(c){c(a)},this)};c=function(a){d.debug.SUBSCRIPTION_COUNT--;delete a._subscribesTo[this._subscriber_hash];delete this._publishesToHash[a._subscriber_hash]};d.base=function(a){function c(){if(arguments.length>0)return b!==arguments[0]&&(b=arguments[0],c.publish(b)),this;f&&j.push(c);return b}var b=a;g(c);return c};d.collection=function(a){function c(){if(arguments.length>0)return d=
arguments[0],c.publish(d),this;f&&j.push(c);return d}function b(a){return function(){typeof d==="undefined"&&(d=[]);var b=d[a].apply(d,arguments);c.publish(d);return b}}var d=a;e("pop,push,reverse,shift,sort,splice,unshift".split(",")).each(function(a){c[a]=b(a)});g(c);return c};h.prototype={push:function(a){e(this.functions).indexOf(a)===-1&&(this.functions.push(a),this.running||this.run())},run:function(){this.running=!0;for(var a=this.functions.length,a=a>3?3:a;a--;);(a=this.functions.shift())?
a(this.complete):this.running=!1},complete:function(){setTimeout(function(){o.run()},1)}};var o=new h;d.dependent=function(a,c){function b(){f&&j.push(b);return h}function k(){d.debug.UPDATE_COUNT++;var g=k._subscribesTo;f=!0;j=[];i.push(j);var p=h;h=a.call(c);var n=e.uniq(i.pop());i.length===0&&(f=!1);j=e(i).last();var m;for(m=g.length;m--;)g[m].unsubscribe(k);for(m=n.length;m--;)n[m].subscribe(k);h!==p&&b.publish(h)}var h;g(b);g(k);k();return b};d.dep=function(a,c){var b=new Function("return "+
a);return d.dependent(b,c)};d.bind=function(a,c,b){var c=c||"",g="data-bind"+(c.length>0?"-"+c:""),k="data-watch"+(c.length>0?"-"+c:""),h=d.dom.nodesWithAttr(g,b),f=l[c]=[];e(h).each(function(c){var b=d.dom.attr(c,g);with(a)eval("var bindingObject = {"+b+"}");e.each(bindingObject,function(b,e){var g=d.binding[e](c,b,a,!1);g instanceof Array?f.concat(g):f.push(g)})});c=d.dom.nodesWithAttr(k,b);e(c).each(function(c){var b=d.dom.attr(c,k);with(a)eval("var bindingObject = {"+b+"}");e.each(bindingObject,
function(b,e){var g=d.binding[e](c,b,a,!0);g instanceof Array?f.concat(g):f.push(g)})});return f};d.unbind=function(a){var a=a||"",c=l[a];if(c)e(c).each(function(a){a.release()}),l[a]=[];else throw Error("Nothing is bound to namespace '"+a+"'");};d.safeSubscribe=function(a,c,b){c=e(c).bind(b);if(a){if(a.subscribe)return a.subscribe(c),c(a()),c;c(a);return c}}})(window.ok,window._);
(function(d){(d.utils={}).toJSON=function b(a){if(typeof a==="function"){if(a.__isSubscribable)return b(a())}else if(typeof a==="object"){var c;c=a instanceof Array?[]:{};for(var d in a)c[d]=b(a[d]);return c}else return a}})(ok,_);
(function(d,e){var b=d.dom;b.nodesWithAttr=function(a,c){var b="*["+a+"]";if(c){var d=e(c).find("*["+a+"]");return e(c).is(b)?e(c).add(d):d}return e(b)};b.createNode=function(a){return e(a)};b.append=function(a,c){e(a).append(c)};b.remove=function(a){e(a).remove()};b.after=function(a,c){e(a).after(c)};b.before=function(a,c){e(a).before(c)};b.attr=function(a,c){return e(a).attr(c)};b.show=function(a){e(a).show()};b.hide=function(a){e(a).hide()};b.text=function(a,c){e(a).html(c)};b.html=function(a,
c){return e(a).html(c)};b.value=function(a,c){return e(a).val(c)};b.bind=function(a,c,b,d){var f=function(){b.call(d)};e(a).bind(c,f);return f};b.unbind=function(a,c,b){e(a).unbind(c,b)};b.attribute=function(a,c,b){return e(a).attr(c,b)};b.removeAttribute=function(a,c){e(a).removeAttr(c)};b.is=function(a,c){return e(a).is(c)}})(window.ok,window.Zepto);(function(d,e){d.template.render=function(b,a){return e.template(b,a)}})(window.ok,window._);
(function(d){function e(b,a){this.node=b;this.subscribable=a;this.subscription=d.safeSubscribe(a,this.update,this)}e.prototype={update:function(b){b?d.dom.show(this.node):d.dom.hide(this.node)},release:function(){this.subscribable.unsubscribe(this.subscription)}};d.binding.visible=function(b,a){return new e(b,a)}})(ok);
(function(d){function e(b,a,c,e){this.update=e?_(this._update).debounce(0):this._update;this.node=b;this.subscribable=a;this.subscription=d.safeSubscribe(a,this.update,this)}e.prototype={_update:function(b){d.dom.html(this.node,b)},release:function(){this.subscribable.unsubscribe(this.subscription)}};d.binding.html=function(b,a,c,d){return new e(b,a,c,d)};d.debug.HtmlBinding=e})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$(b).bind("click",_.bind(this.activate,this))}e.prototype={activate:function(b){this.callback.call(this.vm,[b])||(b.preventDefault(),b.stopPropagation())},release:function(){$(node).unbind("click",this.callback)}};d.binding.click=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$(b).bind("submit",_.bind(this.activate,this))}e.prototype={activate:function(b){this.callback.call(this.vm,[b])||(b.preventDefault(),b.stopPropagation())},release:function(){$(node).unbind("submit",this.callback)}};d.binding.submit=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(b,a,c){this.node=b;this.callback=a;this.vm=c;$.os.ios||$.os.android||$.os.webos||$.os.touchpad||$.os.iphone||$.os.ipad||$.os.blackberry?($(b).bind("tap",_.bind(this.activate,this)),$(b).bind("touchstart",_.bind(this.btn_down,this)),$(b).bind("touchend",_.bind(this.btn_up,this))):($(b).bind("click",_.bind(this.activate,this)),$(b).bind("mousedown",_.bind(this.btn_down,this)),$(b).bind("mouseup",_.bind(this.btn_up,this)))}e.prototype={activate:function(b){this.callback.call(this.vm,
[b])||(b.preventDefault(),b.stopPropagation())},release:function(){},btn_down:function(){$(this.node).addClass("ok_down")},btn_up:function(){$(this.node).removeClass("ok_down")}};d.binding.tap=function(b,a,c){return new e(b,a,c)}})(ok);
(function(d){function e(a,b){this.node=a;this.subscribable=b;_(this).bindAll(["updateNode"]);b.subscribe(this.updateNode);this.updateNode(b());this.bindNode(a)}function b(a,b){this.node=a;this.subscribable=b;_(this).bindAll(["updateNode"]);b.subscribe(this.updateNode);this.updateNode(b());this.bindNode(a)}e.prototype={bindNode:function(a){this.handler=d.dom.bind(a,"keyup",this.updateSubscribable,this)},updateNode:function(a){d.dom.value(this.node,a)},updateSubscribable:function(){this.subscribable(d.dom.value(this.node))},
release:function(){this.subscribable.unsubscribe(this.updateNode);d.dom.unbind(this.node,"keyup",this.handler)}};b.prototype={bindNode:function(a){this.handler=d.dom.bind(a,"change",this.updateSubscribable,this)},updateNode:function(a){a?d.dom.attribute(this.node,"checked",!0):d.dom.removeAttribute(this.node,"checked")},updateSubscribable:function(){this.subscribable(d.dom.is(this.node,":checked")!==!1)},release:function(){d.dom.unbind(this.node,"change",this.handler)}};var a={text:e,checkbox:b};
d.binding.value=function(b,e){var h=d.dom.attribute(b,"type");return new (a[h]||a.text)(b,e)}})(ok);
(function(d){function e(a,b,e,h){this.update=h?_(this._update).debounce(0):this._update;this.node=a;this.templateId="#"+b.template;this.subscribable=b.collection;this._items=[];d.dom.html(this.node,"");this.subscription=d.safeSubscribe(this.subscribable,this.update,this)}var b={};e.prototype={_update:function(a){var c=this,e;typeof b[this.templateId]==="undefined"&&(b[this.templateId]=_.template(d.dom.html(this.templateId)));e=b[this.templateId];var h=_(this._items).pluck("data"),f,i,j=[];_(a).each(function(a,
b){if(c._items.length>b)if(f=c._items[b],f.data===a)j.push(f);else{var l=_(h).indexOf(a);l>=0?(d.dom.before(f.node,c._items[l].node),j.push(c._items[l])):(i=d.dom.createNode(e(a)),d.dom.before(f.node,i),d.bind(a,null,i),j.push({data:a,node:i}))}else i=d.dom.createNode(e(a)),d.dom.append(c.node,i),d.bind(a,null,i),j.push({data:a,node:i})});var l=[];_(this._items).each(function(b){_(a).contains(b.data)||l.push(b)});_(l).each(function(a){d.dom.remove(a.node)});this._items=j},release:function(){this.subscribable.unsubscribe(this.subscription)}};
d.binding.repeat=function(a,b,d,h){return new e(a,b,d,h)};d.debug.RepeatBinding=e})(ok);(function(d){function e(b,a,c){this.node=b;this.className=a;this.subscribable=c;this.subscription=d.safeSubscribe(c,this.update,this)}e.prototype={update:function(b){b?$(this.node).addClass(this.className):$(this.node).removeClass(this.className)},release:function(){this.subscribable.unsubscribe(this.subscription)}};d.binding.css=function(b,a){var c=[],d;for(d in a)c.push(new e(b,d,a[d]));return c}})(ok);
(function(d){function e(b,a,c){this.node=b;this.attrName=a;this.subscribable=c;this.subscription=d.safeSubscribe(c,this.update,this)}e.prototype={update:function(b){$(this.node).attr(this.attrName,b)},release:function(){this.subscribable.unsubscribe(this.subscription)}};d.binding.attr=function(b,a){var c=[],d;for(d in a)c.push(new e(b,d,a[d]));return c}})(ok);
