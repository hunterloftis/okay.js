// Okay.JS
// by Hunter Loftis <hunter@hunterloftis.com>
//
// Version 0.1.0
window.ok=window.ok||{};
(function(d,c){function b(a){a._subscriptions=[];a.subscribe=f.subscribe;a.publish=f.publish;a.unsubscribe=f.unsubscribe;a.__isSubscribable=!0}d.dom={};d.template={};d.binding={};var a,h,k={},f={subscribe:function(a,b){this._subscriptions.push({callback:a,context:b||this});a._publishers=a._publishers||[];c(a._publishers).contains(this)||a._publishers.push(this)},publish:function(a){c(this._subscriptions).each(function(b){b.callback.call(b.context,a)},this)},unsubscribe:function(a){this._subscriptions=c(this._subscriptions).reject(function(b){return b.callback===
a});a._publishers=c(a._publishers).without(this)}};d.base=function(d){function c(){if(arguments.length>0)return g!==arguments[0]&&(g=arguments[0],c.publish(g)),this;a&&h.push(c);return g}var g=d;b(c);return c};d.collection=function(d){function i(){if(arguments.length>0)return e=arguments[0],i.publish(e),this;a&&h.push(i);return e}function g(a){return function(){typeof e==="undefined"&&(e=[]);var b=e[a].apply(e,arguments);i.publish(e);return b}}var e=d;c(["pop","push","reverse","shift","sort","splice",
"unshift"]).each(function(a){i[a]=g(a)});b(i);return i};d.dependent=function(d,i){function g(){a&&h.push(g);return f}function e(){var b=e._publishers?e._publishers.slice():[],k;a=!0;h=[];f=d.call(i);a=!1;k=h=c.uniq(h);var m=c(b).select(function(a){return!c(k).contains(a)}),n=c(k).select(function(a){return!c(b).contains(a)});c(m).each(function(a){a.unsubscribe(e)});c(n).each(function(a){a.subscribe(e)});g.publish(f)}var f;b(g);e();return g};d.bind=function(a,b,h){var b=b||"",e="data-bind"+(b.length>
0?"-"+b:""),h=d.dom.nodesWithAttr(e,h),f=k[b]=[];c(h).each(function(b){var h=d.dom.attr(b,e);with(a)eval("var bindingObject = {"+h+"}");c.each(bindingObject,function(c,h){var e=d.binding[h](b,c,a);f.push(e)})})};d.unbind=function(a){var a=a||"",b=k[a];if(b)c(b).each(function(a){a.release()}),k[a]=[];else throw Error("Nothing is bound to namespace '"+a+"'");};d.safeSubscribe=function(a,b,c){a.subscribe?(a.subscribe(b,c),b.call(c,a())):b.call(c,a)}})(window.ok,window._);
(function(d,c){var b=d.dom;b.nodesWithAttr=function(a,b){if(b)return c(b).find("*["+a+"]");return c("*["+a+"]")};b.createNode=function(a){return c(a)};b.append=function(a,b){c(a).append(b)};b.remove=function(a){c(a).remove()};b.after=function(a,b){c(a).after(b)};b.before=function(a,b){c(a).before(b)};b.attr=function(a,b){return c(a).attr(b)};b.show=function(a){c(a).show()};b.hide=function(a){c(a).hide()};b.text=function(a,b){c(a).html(b)};b.html=function(a,b){return c(a).html(b)};b.value=function(a,
b){return c(a).val(b)};b.bind=function(a,b,d,f){var j=function(){d.call(f)};c(a).bind(b,j);return j};b.unbind=function(a,b,d){c(a).unbind(b,d)}})(window.ok,window.Zepto);(function(d,c){d.template.render=function(b,a){return c.template(b,a)}})(window.ok,window._);
(function(d){function c(b,a){this.node=b;this.subscribable=a;d.safeSubscribe(a,this.update,this)}c.prototype={update:function(b){b?d.dom.show(this.node):d.dom.hide(this.node)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.visible=function(b,a){return new c(b,a)}})(ok);
(function(d){function c(b,a){this.node=b;this.subscribable=a;d.safeSubscribe(a,this.update,this)}c.prototype={update:function(b){d.dom.html(this.node,b)},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.html=function(b,a){return new c(b,a)}})(ok);
(function(d){function c(b,a){this.node=b;this.callback=a;$(b).bind("click",_.bind(this.activate,this))}c.prototype={activate:function(b){this.callback()||(b.preventDefault(),b.stopPropagation())},release:function(){$(node).unbind("click",this.callback)}};d.binding.click=function(b,a){return new c(b,a)}})(ok);
(function(d){function c(b,a){this.node=b;this.subscribable=a;a.subscribe(this.updateNode,this);this.updateNode(a());this.keyup_handler=d.dom.bind(b,"keyup",this.updateSubscribable,this)}c.prototype={updateNode:function(b){d.dom.value(this.node,b)},updateSubscribable:function(){this.subscribable(d.dom.value(this.node))},release:function(){this.subscribable.unsubscribe(this.updateNode);d.dom.unbind(this.node,"keyup",this.keyup_handler)}};d.binding.value=function(b,a){return new c(b,a)}})(ok);
(function(d){function c(b,a){this.node=b;this.templateId="#"+a.template;this.subscribable=a.collection;this._items=[];d.dom.html(this.node,"");d.safeSubscribe(this.subscribable,this.update,this)}c.prototype={update:function(b){var a=this,c=d.dom.html(this.templateId),k=_(this._items).pluck("data"),f,j,i=[];_(b).each(function(b,g){if(a._items.length>g)if(f=a._items[g],f.data===b)i.push(f);else{var l=_(k).indexOf(b);l>=0?(d.dom.before(f.node,a._items[l].node),i.push(a._items[l])):(j=d.dom.createNode(d.template.render(c,
b)),d.bind(b,null,j),d.dom.before(f.node,j),i.push({data:b,node:j}))}else j=d.dom.createNode(d.template.render(c,b)),d.bind(b,null,j),d.dom.append(a.node,j),i.push({data:b,node:j})});var g=[];_(this._items).each(function(a){_(b).contains(a.data)||g.push(a)});_(g).each(function(a){d.dom.remove(a.node)});this._items=i},release:function(){this.subscribable.unsubscribe(this.update)}};d.binding.repeat=function(b,a,d){return new c(b,a,d)}})(ok);
